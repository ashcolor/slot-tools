# 収支ロジック整理

## パチスロ/パチンコの交換率体系

### 基本用語

| 用語 | 意味 |
|------|------|
| 貸出レート | お金を入れてメダル/玉を借りるときの単価 |
| 交換レート | メダル/玉を景品(現金)に換えるときの単価 |
| 等価交換 | 貸出レート = 交換レート（差額なし） |
| 非等価交換 | 貸出レート > 交換レート（差額＝換金ギャップ） |
| 換金ギャップ | 貸出単価 − 交換単価。非等価のとき店側の利益になる部分 |

### 計算式

```
交換単価     = 100 ÷ 交換枚数(100円あたり)
換金ギャップ率 = 1 − (交換単価 ÷ 貸出単価)
換金ギャップ額 = 持ちメダル × (貸出単価 − 交換単価)
```

例: 46枚貸し・47枚交換で1000枚持ち → `1000 × (21.74 - 21.28) ≈ 460円` のギャップ

---

## パチスロの主要レート

### 50枚貸し（従来方式: 1000円 = 50枚, 貸出単価 20円/枚）

| 交換率 | 1枚あたり交換額 | 等価/非等価 | 換金ギャップ率 |
|--------|----------------|------------|--------------|
| 5.0枚/100円 | 20.00円 | 等価 | 0% |
| 5.5枚/100円 | 18.18円 | 非等価 | 9.1% |
| 5.6枚/100円 | 17.86円 | 非等価 | 10.7% |
| 6.0枚/100円 | 16.67円 | 非等価 | 16.7% |
| 7.0枚/100円 | 14.29円 | 非等価 | 28.6% |

### 46枚貸し（現行主流: 1000円 = 46枚, 貸出単価 約21.74円/枚）

| 交換率 | 1枚あたり交換額 | 等価/非等価 | 換金ギャップ率 |
|--------|----------------|------------|--------------|
| 46枚/1000円 | 21.74円 | 等価 | 0% |
| 47枚/1000円 | 21.28円 | 非等価 | 2.1% |

---

## パチンコの主要レート

### 4円パチンコ（1000円 = 250玉, 貸出単価 4円/玉）

| 交換率 | 1玉あたり交換額 | 等価/非等価 | 換金ギャップ率 |
|--------|----------------|------------|--------------|
| 25玉/100円 | 4.00円 | 等価 | 0% |
| 28玉/100円 | 3.57円 | 非等価 | 10.7% |
| 30玉/100円 | 3.33円 | 非等価 | 16.7% |
| 33玉/100円 | 3.03円 | 非等価 | 24.2% |

### 1円パチンコ（1000円 = 1000玉, 貸出単価 1円/玉）

| 交換率 | 1玉あたり交換額 | 等価/非等価 | 換金ギャップ率 |
|--------|----------------|------------|--------------|
| 100玉/100円 | 1.00円 | 等価 | 0% |
| 200玉/100円 | 0.50円 | 非等価 | 50.0% |

---

## 現状のコードのロジック

### 計算フロー（`src/utils/calculate.ts`）

```
投資額 = investMedals × rate + investCash
回収額 = collectMedals × rate + collectCash
損益   = 回収額 − 投資額

取り分 = 自分の投資額 + (全体損益 ÷ 人数)
精算額 = 取り分 − 自分の回収額
```

- 投資にも回収にも同じ `rate` を使用
- 精算は貪欲法で最小回数のやり取りを算出

### 現在の `RATE_OPTIONS`（`src/types.ts`）

| ラベル | 値 (円/枚) | 実質的な意味 |
|--------|-----------|-------------|
| 5 等価 (4円/枚) | 4 | パチンコ 4円等価 |
| 20 等価 (20円/枚) | 20 | パチスロ 50枚貸し等価 |
| 46枚 非等価 (~21.74円/枚) | 1000/46 ≈ 21.74 | パチスロ 46枚貸し（貸出レート） |

### データ構造（`src/types.ts`）

```typescript
interface Member {
  investMedals: number;  // 投資メダル数
  investCash: number;    // 投資現金額
  collectMedals: number; // 回収メダル数
  collectCash: number;   // 回収現金額
}
```

---

## 問題点

### 1. 非等価で貸出レートと交換レートが区別されていない

- 46枚貸しのとき `rate = 21.74`（貸出レート）を投資・回収の両方に使用
- 実際の回収時の交換レートは異なる（例: 47枚交換 → 21.28円/枚）
- 等価のときは問題なし。非等価のときに精算がズレる

### 2. 「46枚 非等価」のラベルだが値は貸出レート

- 非等価なのに交換レートの指定手段がない
- ユーザーが交換レートを意識できない

### 3. 交換レートの選択肢が不足

- 5.5枚交換、5.6枚交換など一般的な非等価レートがない
- 店舗ごとに交換率が異なるためカスタム入力も欲しい

### 4. 乗り打ち精算の本来のロジック

```
投資額 = investMedals × 貸出レート + investCash
回収額 = collectMedals × 交換レート + collectCash
```

等価なら `貸出レート = 交換レート` なので現状コードで正しい。
非等価のときだけ2つのレートを分離する必要がある。

---

## 改善案

### A案: 交換レートを分離する

- 貸出レート（投資計算用）と交換レート（回収計算用）を別々に持つ
- 非等価のとき正確な精算が可能
- UIが複雑になる

### B案: 交換レートのみ使う

- メダルの「実際の現金価値」= 交換レートで統一
- 投資も回収も交換レートで計算
- シンプルだが「実際にいくら使ったか」とズレる

### C案: 現状維持 + 選択肢拡充

- 単一レートのまま、選択肢を増やす（47枚交換、5.5枚交換など）
- ユーザーが「交換レート」を選ぶ想定にラベルを修正
- 最もシンプルだが非等価の精度は妥協

---

## 参考リンク

- [非等価の計算を正確に行う方法](https://sapporoyukyo.com/non-equivalent-calculation/)
- [パチンコ・パチスロのレートとは？](https://chance-up.jp/column/pachinko_rates/)
- [換金率・計算方法・換金所・仕組み](https://rx7038.com/?p=13311)
- [スロット換金率計算ツール](https://slot-hacks.com/slot-kankin-tool/)
- [換金率（交換率）計算ツール・早見表](https://pachisuro100.com/kankinritu/)
- [スロット収支計算ツール（21.27レート対応）](https://kenslo65536.com/tool/inout-calc-2127rate.html)
