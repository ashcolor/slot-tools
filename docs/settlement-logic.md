# 収支ロジック整理

## パチスロ/パチンコの交換率体系

### 基本用語

| 用語         | 意味                                                  |
| ------------ | ----------------------------------------------------- |
| 貸出レート   | お金を入れてメダル/玉を借りるときの単価               |
| 交換レート   | メダル/玉を景品(現金)に換えるときの単価               |
| 等価交換     | 貸出レート = 交換レート（差額なし）                   |
| 非等価交換   | 貸出レート > 交換レート（差額＝換金ギャップ）         |
| 換金ギャップ | 貸出単価 − 交換単価。非等価のとき店側の利益になる部分 |

### 計算式

```
交換単価     = 100 ÷ 交換枚数(100円あたり)
換金ギャップ率 = 1 − (交換単価 ÷ 貸出単価)
換金ギャップ額 = 持ちメダル × (貸出単価 − 交換単価)
```

例: 46枚貸し・47枚交換で1000枚持ち → `1000 × (21.74 - 21.28) ≈ 460円` のギャップ

---

## パチスロの主要レート

### 50枚貸し（従来方式: 1000円 = 50枚, 貸出単価 20円/枚）

| 交換率      | 1枚あたり交換額 | 等価/非等価 | 換金ギャップ率 |
| ----------- | --------------- | ----------- | -------------- |
| 5.0枚/100円 | 20.00円         | 等価        | 0%             |
| 5.5枚/100円 | 18.18円         | 非等価      | 9.1%           |
| 5.6枚/100円 | 17.86円         | 非等価      | 10.7%          |
| 6.0枚/100円 | 16.67円         | 非等価      | 16.7%          |
| 7.0枚/100円 | 14.29円         | 非等価      | 28.6%          |

### 46枚貸し（現行主流: 1000円 = 46枚, 貸出単価 約21.74円/枚）

| 交換率      | 1枚あたり交換額 | 等価/非等価 | 換金ギャップ率 |
| ----------- | --------------- | ----------- | -------------- |
| 46枚/1000円 | 21.74円         | 等価        | 0%             |
| 47枚/1000円 | 21.28円         | 非等価      | 2.1%           |

---

## パチンコの主要レート

### 4円パチンコ（1000円 = 250玉, 貸出単価 4円/玉）

| 交換率     | 1玉あたり交換額 | 等価/非等価 | 換金ギャップ率 |
| ---------- | --------------- | ----------- | -------------- |
| 25玉/100円 | 4.00円          | 等価        | 0%             |
| 28玉/100円 | 3.57円          | 非等価      | 10.7%          |
| 30玉/100円 | 3.33円          | 非等価      | 16.7%          |
| 33玉/100円 | 3.03円          | 非等価      | 24.2%          |

### 1円パチンコ（1000円 = 1000玉, 貸出単価 1円/玉）

| 交換率      | 1玉あたり交換額 | 等価/非等価 | 換金ギャップ率 |
| ----------- | --------------- | ----------- | -------------- |
| 100玉/100円 | 1.00円          | 等価        | 0%             |
| 200玉/100円 | 0.50円          | 非等価      | 50.0%          |

---

## 収支計算ロジック（`src/utils/calculate.ts`）

### データ構造（`src/types.ts`）

```typescript
interface Member {
  investMedals: number; // 投資メダル枚数（貯玉から使った枚数）
  investCash: number; // 投資現金額
  collectMedals: number; // 回収メダル枚数（台から回収した総枚数）
  storedMedals: number; // 貯玉枚数（回収メダルのうち貯玉に回す枚数）
}
```

### 計算フロー

#### Step 1: 投資メダルと貯玉を相殺

```
medalDiff = storedMedals − investMedals
```

- `medalDiff >= 0` → 貯玉が増えた（メダル資産が増加）
- `medalDiff < 0` → 貯玉が減った（メダル資産が減少）

#### Step 2: 換金枚数を算出

```
cashedOut = collectMedals − storedMedals
```

回収メダルのうち貯玉に回さなかった分 = 換金した枚数

#### Step 3: 投資額・回収額を算出

```
回収額 = cashedOut × 交換レート + max(medalDiff, 0) × 交換レート
投資額 = investCash + max(-medalDiff, 0) × 貸出レート
```

- 換金メダルは交換レートで現金化
- 貯玉増加分 → 交換レートで評価（売ればその値段になる）
- 貯玉減少分 → 貸出レートで評価（買い直すとその値段がかかる）

#### Step 4: 収支・精算

```
収支 = 回収額 − 投資額
取り分 = 自分の投資額 + (全体収支 ÷ 人数)
精算額 = 取り分 − 自分の回収額
```

精算は貪欲法で最小回数のやり取りを算出

### 計算例

#### 例1: 等価・貯玉増減なし

投資460枚, 回収460枚, 貯玉460枚, 現金0円 (貸出20円, 交換20円)

```
medalDiff = 460 − 460 = 0
cashedOut = 460 − 460 = 0
回収額 = 0 × 20 + 0 × 20 = 0円
投資額 = 0 + 0 = 0円
収支 = 0円
```

#### 例2: 等価・換金あり

投資460枚, 回収920枚, 貯玉460枚, 現金0円 (貸出20円, 交換20円)

```
medalDiff = 460 − 460 = 0
cashedOut = 920 − 460 = 460
回収額 = 460 × 20 = 9,200円
投資額 = 0円
収支 = +9,200円
```

#### 例3: 非等価・貯玉減少

投資460枚, 回収460枚, 貯玉0枚, 現金0円 (貸出20円, 交換18.18円)

```
medalDiff = 0 − 460 = −460
cashedOut = 460 − 0 = 460
回収額 = 460 × 18.18 = 8,363円
投資額 = 0 + 460 × 20 = 9,200円
収支 = −837円（換金ギャップ分の損失）
```

### レート設定

UIでは「貸出レート」と「交換レート」を別々に設定可能。

| 貸出レート        | 交換レート選択肢                                           |
| ----------------- | ---------------------------------------------------------- |
| 4円パチンコ       | 等価(4円), 28玉(3.57円), 30玉(3.33円), 33玉(3.03円)        |
| 20スロ            | 等価(20円), 5.5枚(18.18円), 5.6枚(17.86円), 6.0枚(16.67円) |
| 46枚貸し(21.74円) | 等価(21.74円), 5.2枚(19.23円)                              |

---

## 参考リンク

- [非等価の計算を正確に行う方法](https://sapporoyukyo.com/non-equivalent-calculation/)
- [パチンコ・パチスロのレートとは？](https://chance-up.jp/column/pachinko_rates/)
- [換金率・計算方法・換金所・仕組み](https://rx7038.com/?p=13311)
- [スロット換金率計算ツール](https://slot-hacks.com/slot-kankin-tool/)
- [換金率（交換率）計算ツール・早見表](https://pachisuro100.com/kankinritu/)
- [スロット収支計算ツール（21.27レート対応）](https://kenslo65536.com/tool/inout-calc-2127rate.html)
